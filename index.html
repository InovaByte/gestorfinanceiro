<html><head><base href="https://www.binance.com/"><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Bot de Trading Binance Futures - Estratégia de Seguimento de Tendência</title><style>
body {
  font-size: 16px;
  padding: 1rem;
  font-family: Arial, sans-serif;
  background-color: #f0f2f5;
  margin: 0;
  color: #333;
}
.container {
  max-width: 100%;
  margin: 0 auto;
  background-color: #fff;
  border-radius: 8px;
  padding: 1rem;
  box-shadow: 0 0 10px rgba(0,0,0,0.1);
}
h1 {
  color: #f0b90b;
  text-align: center;
  font-size: 1.5rem;
}
.controls {
  display: flex;
  justify-content: space-between;
  margin-bottom: 20px;
}
button {
  background-color: #f0b90b;
  border: none;
  color: white;
  padding: 0.5rem 1rem;
  text-align: center;
  text-decoration: none;
  display: inline-block;
  font-size: 1rem;
  margin: 4px 2px;
  cursor: pointer;
  border-radius: 4px;
}
.stats {
  display: flex;
  justify-content: space-between;
  background-color: #f8f9fa;
  padding: 10px;
  border-radius: 4px;
  margin-bottom: 20px;
}
.stat {
  text-align: center;
}
.stat-value {
  font-size: 1.2rem;
  font-weight: bold;
  color: #f0b90b;
}
#log {
  margin-top: 20px;
  max-height: 200px;
  overflow-y: auto;
  border: 1px solid #ddd;
  padding: 10px;
  font-family: monospace;
}
#signals {
  margin-top: 20px;
  border: 1px solid #ddd;
  padding: 10px;
  border-radius: 4px;
  max-height: 200px;
  overflow-y: auto;
}
.signal {
  margin-bottom: 10px;
  padding: 10px;
  border-radius: 4px;
}
.signal.buy {
  background-color: #d4edda;
  color: #155724;
}
.signal.sell {
  background-color: #f8d7da;
  color: #721c24;
}
#tradingview-widget-container {
  position: relative;
  height: 0;
  padding-bottom: 56.25%;
  margin-bottom: 20px;
}
#tradingview-widget-container > div {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
}
#symbolSelector {
  width: 100%;
  padding: 10px;
  margin-bottom: 20px;
  font-size: 16px;
}
@media (min-width: 768px) {
  .container {
    max-width: 1200px;
    padding: 2rem;
  }
  
  h1 {
    font-size: 2rem;
  }
  
  .controls {
    flex-direction: row;
  }
  
  button {
    width: auto;
  }
  
  .stats {
    flex-direction: row;
  }
  
  .stat {
    margin-bottom: 0;
  }
  
  #tradingview-widget-container {
    height: 400px !important;
  }
}
@media (min-width: 1024px) {
  .container {
    padding: 2.5rem;
  }
  
  h1 {
    font-size: 2.5rem;
  }
  
  #tradingview-widget-container {
    height: 500px !important;
  }
}
</style>
</head>
<body>
  <div class="container" style="height: 100%;">
    <h1>Bot de Trading Binance Futures - Estratégia de Seguimento de Tendência</h1>
    <select id="symbolSelector"><option value="BTCUSDT">BTCUSDT</option><option value="ETHUSDT">ETHUSDT</option><option value="BCHUSDT">BCHUSDT</option><option value="XRPUSDT">XRPUSDT</option><option value="EOSUSDT">EOSUSDT</option><option value="LTCUSDT">LTCUSDT</option><option value="TRXUSDT">TRXUSDT</option><option value="ETCUSDT">ETCUSDT</option><option value="LINKUSDT">LINKUSDT</option><option value="XLMUSDT">XLMUSDT</option><option value="ADAUSDT">ADAUSDT</option><option value="XMRUSDT">XMRUSDT</option><option value="DASHUSDT">DASHUSDT</option><option value="ZECUSDT">ZECUSDT</option><option value="XTZUSDT">XTZUSDT</option><option value="BNBUSDT">BNBUSDT</option><option value="ATOMUSDT">ATOMUSDT</option><option value="ONTUSDT">ONTUSDT</option><option value="IOTAUSDT">IOTAUSDT</option><option value="BATUSDT">BATUSDT</option><option value="VETUSDT">VETUSDT</option><option value="NEOUSDT">NEOUSDT</option><option value="QTUMUSDT">QTUMUSDT</option><option value="IOSTUSDT">IOSTUSDT</option><option value="THETAUSDT">THETAUSDT</option><option value="ALGOUSDT">ALGOUSDT</option><option value="ZILUSDT">ZILUSDT</option><option value="KNCUSDT">KNCUSDT</option><option value="ZRXUSDT">ZRXUSDT</option><option value="COMPUSDT">COMPUSDT</option><option value="OMGUSDT">OMGUSDT</option><option value="DOGEUSDT">DOGEUSDT</option><option value="SXPUSDT">SXPUSDT</option><option value="KAVAUSDT">KAVAUSDT</option><option value="BANDUSDT">BANDUSDT</option><option value="RLCUSDT">RLCUSDT</option><option value="WAVESUSDT">WAVESUSDT</option><option value="MKRUSDT">MKRUSDT</option><option value="SNXUSDT">SNXUSDT</option><option value="DOTUSDT">DOTUSDT</option><option value="DEFIUSDT">DEFIUSDT</option><option value="YFIUSDT">YFIUSDT</option><option value="BALUSDT">BALUSDT</option><option value="CRVUSDT">CRVUSDT</option><option value="TRBUSDT">TRBUSDT</option><option value="RUNEUSDT">RUNEUSDT</option><option value="SUSHIUSDT">SUSHIUSDT</option><option value="EGLDUSDT">EGLDUSDT</option><option value="SOLUSDT">SOLUSDT</option><option value="ICXUSDT">ICXUSDT</option><option value="STORJUSDT">STORJUSDT</option><option value="BLZUSDT">BLZUSDT</option><option value="UNIUSDT">UNIUSDT</option><option value="AVAXUSDT">AVAXUSDT</option><option value="FTMUSDT">FTMUSDT</option><option value="ENJUSDT">ENJUSDT</option><option value="FLMUSDT">FLMUSDT</option><option value="RENUSDT">RENUSDT</option><option value="KSMUSDT">KSMUSDT</option><option value="NEARUSDT">NEARUSDT</option><option value="AAVEUSDT">AAVEUSDT</option><option value="FILUSDT">FILUSDT</option><option value="RSRUSDT">RSRUSDT</option><option value="LRCUSDT">LRCUSDT</option><option value="OCEANUSDT">OCEANUSDT</option><option value="CVCUSDT">CVCUSDT</option><option value="BELUSDT">BELUSDT</option><option value="CTKUSDT">CTKUSDT</option><option value="AXSUSDT">AXSUSDT</option><option value="ALPHAUSDT">ALPHAUSDT</option><option value="ZENUSDT">ZENUSDT</option><option value="SKLUSDT">SKLUSDT</option><option value="GRTUSDT">GRTUSDT</option><option value="1INCHUSDT">1INCHUSDT</option><option value="CHZUSDT">CHZUSDT</option><option value="SANDUSDT">SANDUSDT</option><option value="ANKRUSDT">ANKRUSDT</option><option value="LITUSDT">LITUSDT</option><option value="UNFIUSDT">UNFIUSDT</option><option value="REEFUSDT">REEFUSDT</option><option value="RVNUSDT">RVNUSDT</option><option value="SFPUSDT">SFPUSDT</option><option value="XEMUSDT">XEMUSDT</option><option value="BTCSTUSDT">BTCSTUSDT</option><option value="COTIUSDT">COTIUSDT</option><option value="CHRUSDT">CHRUSDT</option><option value="MANAUSDT">MANAUSDT</option><option value="ALICEUSDT">ALICEUSDT</option><option value="HBARUSDT">HBARUSDT</option><option value="ONEUSDT">ONEUSDT</option><option value="LINAUSDT">LINAUSDT</option><option value="STMXUSDT">STMXUSDT</option><option value="DENTUSDT">DENTUSDT</option><option value="CELRUSDT">CELRUSDT</option><option value="HOTUSDT">HOTUSDT</option><option value="MTLUSDT">MTLUSDT</option><option value="OGNUSDT">OGNUSDT</option><option value="NKNUSDT">NKNUSDT</option><option value="SCUSDT">SCUSDT</option><option value="DGBUSDT">DGBUSDT</option><option value="1000SHIBUSDT">1000SHIBUSDT</option><option value="BAKEUSDT">BAKEUSDT</option><option value="GTCUSDT">GTCUSDT</option><option value="BTCDOMUSDT">BTCDOMUSDT</option><option value="IOTXUSDT">IOTXUSDT</option><option value="RAYUSDT">RAYUSDT</option><option value="C98USDT">C98USDT</option><option value="MASKUSDT">MASKUSDT</option><option value="ATAUSDT">ATAUSDT</option><option value="DYDXUSDT">DYDXUSDT</option><option value="1000XECUSDT">1000XECUSDT</option><option value="GALAUSDT">GALAUSDT</option><option value="CELOUSDT">CELOUSDT</option><option value="ARUSDT">ARUSDT</option><option value="KLAYUSDT">KLAYUSDT</option><option value="ARPAUSDT">ARPAUSDT</option><option value="CTSIUSDT">CTSIUSDT</option><option value="LPTUSDT">LPTUSDT</option><option value="ENSUSDT">ENSUSDT</option><option value="PEOPLEUSDT">PEOPLEUSDT</option><option value="ROSEUSDT">ROSEUSDT</option><option value="DUSKUSDT">DUSKUSDT</option><option value="FLOWUSDT">FLOWUSDT</option><option value="IMXUSDT">IMXUSDT</option><option value="API3USDT">API3USDT</option><option value="GMTUSDT">GMTUSDT</option><option value="APEUSDT">APEUSDT</option><option value="WOOUSDT">WOOUSDT</option><option value="FTTUSDT">FTTUSDT</option><option value="JASMYUSDT">JASMYUSDT</option><option value="DARUSDT">DARUSDT</option><option value="OPUSDT">OPUSDT</option><option value="INJUSDT">INJUSDT</option><option value="STGUSDT">STGUSDT</option><option value="SPELLUSDT">SPELLUSDT</option><option value="1000LUNCUSDT">1000LUNCUSDT</option><option value="LUNA2USDT">LUNA2USDT</option><option value="LDOUSDT">LDOUSDT</option><option value="CVXUSDT">CVXUSDT</option><option value="ICPUSDT">ICPUSDT</option><option value="APTUSDT">APTUSDT</option><option value="QNTUSDT">QNTUSDT</option><option value="FETUSDT">FETUSDT</option><option value="FXSUSDT">FXSUSDT</option><option value="HOOKUSDT">HOOKUSDT</option><option value="MAGICUSDT">MAGICUSDT</option><option value="TUSDT">TUSDT</option><option value="HIGHUSDT">HIGHUSDT</option><option value="MINAUSDT">MINAUSDT</option><option value="ASTRUSDT">ASTRUSDT</option><option value="AGIXUSDT">AGIXUSDT</option><option value="PHBUSDT">PHBUSDT</option><option value="GMXUSDT">GMXUSDT</option><option value="CFXUSDT">CFXUSDT</option><option value="STXUSDT">STXUSDT</option><option value="BNXUSDT">BNXUSDT</option><option value="ACHUSDT">ACHUSDT</option><option value="SSVUSDT">SSVUSDT</option><option value="CKBUSDT">CKBUSDT</option><option value="PERPUSDT">PERPUSDT</option><option value="TRUUSDT">TRUUSDT</option><option value="LQTYUSDT">LQTYUSDT</option><option value="USDCUSDT">USDCUSDT</option><option value="IDUSDT">IDUSDT</option><option value="ARBUSDT">ARBUSDT</option><option value="JOEUSDT">JOEUSDT</option><option value="TLMUSDT">TLMUSDT</option><option value="AMBUSDT">AMBUSDT</option><option value="LEVERUSDT">LEVERUSDT</option><option value="RDNTUSDT">RDNTUSDT</option><option value="HFTUSDT">HFTUSDT</option><option value="XVSUSDT">XVSUSDT</option><option value="ETHBTC">ETHBTC</option><option value="BLURUSDT">BLURUSDT</option><option value="EDUUSDT">EDUUSDT</option><option value="IDEXUSDT">IDEXUSDT</option><option value="SUIUSDT">SUIUSDT</option><option value="1000PEPEUSDT">1000PEPEUSDT</option><option value="1000FLOKIUSDT">1000FLOKIUSDT</option><option value="UMAUSDT">UMAUSDT</option><option value="RADUSDT">RADUSDT</option><option value="KEYUSDT">KEYUSDT</option><option value="COMBOUSDT">COMBOUSDT</option><option value="NMRUSDT">NMRUSDT</option><option value="MAVUSDT">MAVUSDT</option><option value="MDTUSDT">MDTUSDT</option><option value="XVGUSDT">XVGUSDT</option><option value="WLDUSDT">WLDUSDT</option><option value="PENDLEUSDT">PENDLEUSDT</option><option value="ARKMUSDT">ARKMUSDT</option><option value="AGLDUSDT">AGLDUSDT</option><option value="YGGUSDT">YGGUSDT</option><option value="DODOXUSDT">DODOXUSDT</option><option value="BNTUSDT">BNTUSDT</option><option value="OXTUSDT">OXTUSDT</option><option value="SEIUSDT">SEIUSDT</option><option value="CYBERUSDT">CYBERUSDT</option><option value="HIFIUSDT">HIFIUSDT</option><option value="ARKUSDT">ARKUSDT</option><option value="GLMRUSDT">GLMRUSDT</option><option value="BICOUSDT">BICOUSDT</option><option value="STRAXUSDT">STRAXUSDT</option><option value="LOOMUSDT">LOOMUSDT</option><option value="BIGTIMEUSDT">BIGTIMEUSDT</option><option value="BONDUSDT">BONDUSDT</option><option value="ORBSUSDT">ORBSUSDT</option><option value="STPTUSDT">STPTUSDT</option><option value="WAXPUSDT">WAXPUSDT</option><option value="BSVUSDT">BSVUSDT</option><option value="RIFUSDT">RIFUSDT</option><option value="POLYXUSDT">POLYXUSDT</option><option value="GASUSDT">GASUSDT</option><option value="POWRUSDT">POWRUSDT</option><option value="SLPUSDT">SLPUSDT</option><option value="TIAUSDT">TIAUSDT</option><option value="SNTUSDT">SNTUSDT</option><option value="CAKEUSDT">CAKEUSDT</option><option value="MEMEUSDT">MEMEUSDT</option><option value="TWTUSDT">TWTUSDT</option><option value="TOKENUSDT">TOKENUSDT</option><option value="ORDIUSDT">ORDIUSDT</option><option value="STEEMUSDT">STEEMUSDT</option><option value="BADGERUSDT">BADGERUSDT</option><option value="ILVUSDT">ILVUSDT</option><option value="NTRNUSDT">NTRNUSDT</option><option value="KASUSDT">KASUSDT</option><option value="BEAMXUSDT">BEAMXUSDT</option><option value="1000BONKUSDT">1000BONKUSDT</option><option value="PYTHUSDT">PYTHUSDT</option><option value="SUPERUSDT">SUPERUSDT</option><option value="USTCUSDT">USTCUSDT</option><option value="ONGUSDT">ONGUSDT</option><option value="ETHWUSDT">ETHWUSDT</option><option value="JTOUSDT">JTOUSDT</option><option value="1000SATSUSDT">1000SATSUSDT</option><option value="AUCTIONUSDT">AUCTIONUSDT</option><option value="1000RATSUSDT">1000RATSUSDT</option><option value="ACEUSDT">ACEUSDT</option><option value="MOVRUSDT">MOVRUSDT</option><option value="NFPUSDT">NFPUSDT</option><option value="BTCUSDC">BTCUSDC</option><option value="ETHUSDC">ETHUSDC</option><option value="BNBUSDC">BNBUSDC</option><option value="SOLUSDC">SOLUSDC</option><option value="XRPUSDC">XRPUSDC</option><option value="AIUSDT">AIUSDT</option><option value="XAIUSDT">XAIUSDT</option><option value="DOGEUSDC">DOGEUSDC</option><option value="WIFUSDT">WIFUSDT</option><option value="MANTAUSDT">MANTAUSDT</option><option value="ONDOUSDT">ONDOUSDT</option><option value="LSKUSDT">LSKUSDT</option><option value="ALTUSDT">ALTUSDT</option><option value="JUPUSDT">JUPUSDT</option><option value="ZETAUSDT">ZETAUSDT</option><option value="RONINUSDT">RONINUSDT</option><option value="DYMUSDT">DYMUSDT</option><option value="SUIUSDC">SUIUSDC</option><option value="OMUSDT">OMUSDT</option><option value="LINKUSDC">LINKUSDC</option><option value="PIXELUSDT">PIXELUSDT</option><option value="STRKUSDT">STRKUSDT</option><option value="MAVIAUSDT">MAVIAUSDT</option><option value="ORDIUSDC">ORDIUSDC</option><option value="GLMUSDT">GLMUSDT</option><option value="PORTALUSDT">PORTALUSDT</option><option value="TONUSDT">TONUSDT</option><option value="AXLUSDT">AXLUSDT</option><option value="MYROUSDT">MYROUSDT</option><option value="1000PEPEUSDC">1000PEPEUSDC</option><option value="METISUSDT">METISUSDT</option><option value="AEVOUSDT">AEVOUSDT</option><option value="WLDUSDC">WLDUSDC</option><option value="VANRYUSDT">VANRYUSDT</option><option value="BOMEUSDT">BOMEUSDT</option><option value="ETHFIUSDT">ETHFIUSDT</option><option value="AVAXUSDC">AVAXUSDC</option><option value="1000SHIBUSDC">1000SHIBUSDC</option><option value="ENAUSDT">ENAUSDT</option><option value="WUSDT">WUSDT</option><option value="WIFUSDC">WIFUSDC</option><option value="BCHUSDC">BCHUSDC</option><option value="TNSRUSDT">TNSRUSDT</option><option value="SAGAUSDT">SAGAUSDT</option><option value="LTCUSDC">LTCUSDC</option><option value="NEARUSDC">NEARUSDC</option><option value="TAOUSDT">TAOUSDT</option><option value="OMNIUSDT">OMNIUSDT</option><option value="ARBUSDC">ARBUSDC</option><option value="NEOUSDC">NEOUSDC</option><option value="FILUSDC">FILUSDC</option><option value="TIAUSDC">TIAUSDC</option><option value="BOMEUSDC">BOMEUSDC</option><option value="REZUSDT">REZUSDT</option><option value="ENAUSDC">ENAUSDC</option><option value="ETHFIUSDC">ETHFIUSDC</option><option value="1000BONKUSDC">1000BONKUSDC</option><option value="BBUSDT">BBUSDT</option><option value="NOTUSDT">NOTUSDT</option><option value="TURBOUSDT">TURBOUSDT</option><option value="IOUSDT">IOUSDT</option><option value="ZKUSDT">ZKUSDT</option><option value="MEWUSDT">MEWUSDT</option><option value="LISTAUSDT">LISTAUSDT</option><option value="ZROUSDT">ZROUSDT</option><option value="BTCUSDT_241227">BTCUSDT_241227</option><option value="ETHUSDT_241227">ETHUSDT_241227</option><option value="CRVUSDC">CRVUSDC</option><option value="RENDERUSDT">RENDERUSDT</option><option value="BANANAUSDT">BANANAUSDT</option><option value="RAREUSDT">RAREUSDT</option><option value="GUSDT">GUSDT</option><option value="SYNUSDT">SYNUSDT</option><option value="SYSUSDT">SYSUSDT</option><option value="VOXELUSDT">VOXELUSDT</option><option value="BRETTUSDT">BRETTUSDT</option><option value="ALPACAUSDT">ALPACAUSDT</option><option value="POPCATUSDT">POPCATUSDT</option><option value="SUNUSDT">SUNUSDT</option><option value="VIDTUSDT">VIDTUSDT</option><option value="NULSUSDT">NULSUSDT</option><option value="DOGSUSDT">DOGSUSDT</option><option value="MBOXUSDT">MBOXUSDT</option><option value="CHESSUSDT">CHESSUSDT</option><option value="FLUXUSDT">FLUXUSDT</option><option value="BSWUSDT">BSWUSDT</option><option value="QUICKUSDT">QUICKUSDT</option><option value="NEIROETHUSDT">NEIROETHUSDT</option><option value="RPLUSDT">RPLUSDT</option><option value="AERGOUSDT">AERGOUSDT</option><option value="POLUSDT">POLUSDT</option><option value="UXLINKUSDT">UXLINKUSDT</option><option value="1MBABYDOGEUSDT">1MBABYDOGEUSDT</option><option value="NEIROUSDT">NEIROUSDT</option><option value="KDAUSDT">KDAUSDT</option><option value="FIDAUSDT">FIDAUSDT</option><option value="FIOUSDT">FIOUSDT</option><option value="CATIUSDT">CATIUSDT</option><option value="GHSTUSDT">GHSTUSDT</option><option value="LOKAUSDT">LOKAUSDT</option><option value="HMSTRUSDT">HMSTRUSDT</option><option value="BTCUSDT_250328">BTCUSDT_250328</option><option value="ETHUSDT_250328">ETHUSDT_250328</option><option value="REIUSDT">REIUSDT</option><option value="COSUSDT">COSUSDT</option><option value="EIGENUSDT">EIGENUSDT</option><option value="DIAUSDT">DIAUSDT</option></select>
    <div class="controls">
      <button id="startBtn">Iniciar Bot</button>
      <button id="stopBtn">Parar Bot</button>
    </div>
    <div id="tradingview-widget-container" style="height: 100%;"><div id="tradingview_2e5f8-wrapper" style="position: relative; box-sizing: content-box; font-family: -apple-system, BlinkMacSystemFont, &quot;Trebuchet MS&quot;, Roboto, Ubuntu, sans-serif; margin: 0px auto !important; padding: 0px !important; width: 100%; height: 100%;"><iframe title="advanced chart TradingView widget" lang="en" id="tradingview_2e5f8" frameborder="0" allowtransparency="true" scrolling="no" allowfullscreen="true" src="https://s.tradingview.com/widgetembed/?hideideas=1&amp;overrides=%7B%7D&amp;enabled_features=%5B%5D&amp;disabled_features=%5B%5D&amp;locale=br#%7B%22symbol%22%3A%22BINANCE%3ABTCUSDT%22%2C%22frameElementId%22%3A%22tradingview_2e5f8%22%2C%22interval%22%3A%2215%22%2C%22hide_side_toolbar%22%3A%220%22%2C%22allow_symbol_change%22%3A%221%22%2C%22save_image%22%3A%221%22%2C%22studies%22%3A%22MASimple%40tv-basicstudies%5Cu001fMASimple%40tv-basicstudies%5Cu001fRSI%40tv-basicstudies%5Cu001fMACD%40tv-basicstudies%5Cu001fBB%40tv-basicstudies%22%2C%22theme%22%3A%22light%22%2C%22style%22%3A%221%22%2C%22timezone%22%3A%22Etc%2FUTC%22%2C%22studies_overrides%22%3A%22%7B%5C%22moving%20average.length%5C%22%3A9%2C%5C%22moving%20average.1.length%5C%22%3A21%2C%5C%22relative%20strength%20index.length%5C%22%3A14%2C%5C%22moving%20average%20convergence%2Fdivergence.fast%20length%5C%22%3A12%2C%5C%22moving%20average%20convergence%2Fdivergence.slow%20length%5C%22%3A26%2C%5C%22moving%20average%20convergence%2Fdivergence.signal%20smoothing%5C%22%3A9%2C%5C%22bollinger%20bands.length%5C%22%3A20%2C%5C%22bollinger%20bands.stddev%5C%22%3A2%7D%22%2C%22utm_medium%22%3A%22widget%22%2C%22utm_campaign%22%3A%22chart%22%2C%22utm_term%22%3A%22BINANCE%3ABTCUSDT%22%2C%22page-uri%22%3A%22__NHTTP__%22%7D" style="width: 100%; height: 100%; margin: 0px !important; padding: 0px !important;"></iframe></div></div>
    <div class="stats">
      <div class="stat">
        <div>Sinais Gerados</div>
        <div id="signalsCount" class="stat-value">0</div>
      </div>
      <div class="stat">
        <div>Último Preço</div>
        <div id="lastPrice" class="stat-value">0 USDT</div>
      </div>
      <div class="stat">
        <div>Posições Abertas</div>
        <div id="openPositions" class="stat-value">0</div>
      </div>
    </div>
    <div id="signals"></div>
    <div id="log"></div>
  </div>

<script src="https://s3.tradingview.com/tv.js"></script>
<script>
let symbol = 'BTCUSDT';
const interval = '15m';
let leverage = 20;
let positions = [];
let lastSignalTime = 0;
const signalCooldown = 15 * 60 * 1000; // 15 minutes in milliseconds

let isRunning = false;
let ws;
let signalsCount = 0;
let prices = [];
let volumes = [];
let ema50 = [];
let ema200 = [];
let rsiValues = [];
let widget;
let reconnectAttempts = 0;
const maxReconnectAttempts = 5;
const baseReconnectDelay = 1000;

function calculateEMA(data, period) {
  const k = 2 / (period + 1);
  let ema = data[0];
  return data.map((price, i) => {
    if (i === 0) return ema;
    return (price * k) + (ema * (1 - k));
  });
}

function logMessage(message) {
  console.log(message);
  const logElement = document.getElementById('log');
  const logEntry = document.createElement('div');
  logEntry.textContent = `${new Date().toLocaleTimeString()} - ${message}`;
  logElement.appendChild(logEntry);
  logElement.scrollTop = logElement.scrollHeight;
}

function displaySignal(signal, price) {
  signalsCount++;
  document.getElementById('signalsCount').textContent = signalsCount;

  const signalsContainer = document.getElementById('signals');
  const signalElement = document.createElement('div');
  signalElement.className = `signal ${signal}`;
  
  const lastRSI = rsiValues[rsiValues.length - 1].toFixed(2);
  const lastSMA50 = calculateSMA(prices, 50)[prices.length - 1].toFixed(2);
  const lastSMA200 = calculateSMA(prices, 200)[prices.length - 1].toFixed(2);
  const { macdLine, signalLine } = calculateMACD(prices);
  const lastMACD = macdLine[macdLine.length - 1].toFixed(2);
  const lastSignalLine = signalLine[signalLine.length - 1].toFixed(2);

  signalElement.innerHTML = `
    <strong>${signal.toUpperCase()} signal at ${price} USDT</strong><br>
    RSI: ${lastRSI}<br>
    SMA50: ${lastSMA50}<br>
    SMA200: ${lastSMA200}<br>
    MACD: ${lastMACD}<br>
    Signal Line: ${lastSignalLine}
  `;
  
  signalsContainer.insertBefore(signalElement, signalsContainer.firstChild);

  if (signalsContainer.children.length > 10) {
    signalsContainer.removeChild(signalsContainer.lastChild);
  }
}

function generateSignal() {
  if (prices.length < 200) {
    return null;
  }

  const lastPrice = prices[prices.length - 1];
  const sma50 = calculateSMA(prices, 50);
  const sma200 = calculateSMA(prices, 200);
  const rsi = calculateRSI(prices, 14);
  const { macdLine, signalLine } = calculateMACD(prices);
  const bollingerBands = calculateBollingerBands(prices);

  const lastSMA50 = sma50[sma50.length - 1];
  const lastSMA200 = sma200[sma200.length - 1];
  const lastRSI = rsi[rsi.length - 1];
  const lastMACD = macdLine[macdLine.length - 1];
  const lastSignal = signalLine[signalLine.length - 1];
  const lastUpperBB = bollingerBands.upper[bollingerBands.upper.length - 1];
  const lastLowerBB = bollingerBands.lower[bollingerBands.lower.length - 1];
  const lastMiddleBB = bollingerBands.middle[bollingerBands.middle.length - 1];

  const currentTime = Date.now();
  if (currentTime - lastSignalTime < signalCooldown) {
    return null;
  }

  const isBuySignal = 
    lastSMA50 > lastSMA200 &&
    lastRSI > 40 && lastRSI < 60 &&
    lastMACD > lastSignal &&
    lastPrice > lastMiddleBB &&
    prices.slice(-5).every(price => price > lastSMA50);

  const isSellSignal = 
    lastSMA50 < lastSMA200 &&
    lastRSI > 60 &&
    lastMACD < lastSignal &&
    lastPrice < lastMiddleBB &&
    prices.slice(-5).every(price => price < lastSMA50);

  if (isBuySignal) {
    lastSignalTime = currentTime;
    return 'buy';
  } else if (isSellSignal) {
    lastSignalTime = currentTime;
    return 'sell';
  }

  return null;
}

function openPosition(type, entryPrice) {
  const currentTime = Date.now();
  if (currentTime - lastSignalTime < signalCooldown) {
    logMessage(`Signal ignored due to cooldown period`);
    return;
  }

  const conflictingPosition = positions.find(p => p.type !== type);
  if (conflictingPosition) {
    logMessage(`Cannot open ${type} position. Conflicting ${conflictingPosition.type} position exists.`);
    return;
  }

  const riskPercentage = 0.02;
  const accountBalance = 10000;
  const riskAmount = accountBalance * riskPercentage;
  const stopLossPercentage = 0.02;
  const takeProfitRatio = 2;

  const stopLossPrice = type === 'buy' 
    ? entryPrice * (1 - stopLossPercentage) 
    : entryPrice * (1 + stopLossPercentage);
  
  const takeProfitPrice = type === 'buy'
    ? entryPrice * (1 + (stopLossPercentage * takeProfitRatio))
    : entryPrice * (1 - (stopLossPercentage * takeProfitRatio));

  const position = {
    type,
    entryPrice,
    stopLossPrice,
    takeProfitPrice,
    trailingStopDistance: entryPrice * 0.015,
    quantity: riskAmount / Math.abs(entryPrice - stopLossPrice)
  };

  positions.push(position);
  logMessage(`Opened ${type} position: Entry: ${entryPrice}, SL: ${stopLossPrice}, TP: ${takeProfitPrice}`);

  lastSignalTime = currentTime;
}

function normalWebSocketHandler(event) {
  const data = JSON.parse(event.data);
  if (data.k) {
    const candle = data.k;
    const closePrice = parseFloat(candle.c);
    
    prices.push(closePrice);
    volumes.push(parseFloat(candle.v));
    
    if (prices.length > 200) {
      prices.shift();
      volumes.shift();
    }
    
    ema50 = calculateEMA(prices, 50);
    ema200 = calculateEMA(prices, 200);
    rsiValues = calculateRSI(prices);
    
    document.getElementById('lastPrice').textContent = `${closePrice} USDT`;
    
    const signal = generateSignal();
    if (signal) {
      displaySignal(signal, closePrice);
      openPosition(signal, closePrice);
    }
    
    updatePositions(closePrice);
    document.getElementById('openPositions').textContent = positions.length;
  }
}

document.addEventListener('DOMContentLoaded', async function() {
  try {
    const symbols = await fetchBinanceSymbols();
    populateSymbolSelector(symbols);

    document.getElementById('startBtn').addEventListener('click', () => {
      if (!isRunning) {
        isRunning = true;
        logMessage('Iniciando bot...');
        runBot();
      }
    });

    document.getElementById('stopBtn').addEventListener('click', () => {
      if (isRunning) {
        isRunning = false;
        if (ws) ws.close();
        logMessage('Parando bot...');
      }
    });

    document.getElementById('symbolSelector').addEventListener('change', (event) => {
      const newSymbol = event.target.value;
      updateSymbol(newSymbol);
    });

    initTradingViewWidget(symbol);
  } catch (error) {
    console.error('Error during initialization:', error);
    logMessage(`Erro durante a inicialização: ${error.message}`);
  }
});

async function fetchBinanceSymbols() {
  try {
    const response = await fetch('https://fapi.binance.com/fapi/v1/exchangeInfo');
    const data = await response.json();
    return data.symbols.map(symbol => symbol.symbol);
  } catch (error) {
    console.error('Error fetching Binance symbols:', error);
    logMessage(`Erro ao buscar símbolos da Binance: ${error.message}`);
    return [];
  }
}

function populateSymbolSelector(symbols) {
  const selector = document.getElementById('symbolSelector');
  symbols.forEach(sym => {
    const option = document.createElement('option');
    option.value = sym;
    option.textContent = sym;
    selector.appendChild(option);
  });
}

function updateSymbol(newSymbol) {
  symbol = newSymbol;
  if (widget && widget.chart && typeof widget.chart().setSymbol === 'function') {
    widget.chart().setSymbol(newSymbol, {
      interval: interval
    });
  } else {
    console.error('TradingView widget not ready or setSymbol method not available');
    logMessage('Erro ao atualizar o gráfico. Tentando reiniciar o widget...');
    initTradingViewWidget(newSymbol);
  }
  resetBot();
  if (isRunning) {
    runBot();
  }
}

function resetBot() {
  if (ws) {
    ws.close();
  }
  prices = [];
  volumes = [];
  ema50 = [];
  ema200 = [];
  rsiValues = [];
  positions = [];
  signalsCount = 0;
  reconnectAttempts = 0;
  document.getElementById('signalsCount').textContent = '0';
  document.getElementById('lastPrice').textContent = '0 USDT';
  document.getElementById('openPositions').textContent = '0';
  document.getElementById('signals').innerHTML = '';
  document.getElementById('log').innerHTML = '';
}

function calculateSMA(data, period) {
  return data.map((_, index, array) => 
    array.slice(Math.max(0, index - period + 1), index + 1)
      .reduce((sum, value) => sum + value, 0) / period
  );
}

function calculateMACD(data, shortPeriod = 12, longPeriod = 26, signalPeriod = 9) {
  const shortEMA = calculateEMA(data, shortPeriod);
  const longEMA = calculateEMA(data, longPeriod);
  const macdLine = shortEMA.map((short, i) => short - longEMA[i]);
  const signalLine = calculateEMA(macdLine, signalPeriod);
  return { macdLine, signalLine };
}

function calculateBollingerBands(data, period = 20, stdDev = 2) {
  const sma = calculateSMA(data, period);
  const stdDevs = data.map((_, index, array) => {
    const slice = array.slice(Math.max(0, index - period + 1), index + 1);
    const mean = sma[index];
    const squaredDiffs = slice.map(value => Math.pow(value - mean, 2));
    const variance = squaredDiffs.reduce((sum, value) => sum + value, 0) / period;
    return Math.sqrt(variance);
  });
  
  const upperBand = sma.map((value, index) => value + (stdDev * stdDevs[index]));
  const lowerBand = sma.map((value, index) => value - (stdDev * stdDevs[index]));
  
  return { middle: sma, upper: upperBand, lower: lowerBand };
}

function calculateRSI(prices, period = 14) {
  if (prices.length < period + 1) {
    return null;
  }

  let gains = 0;
  let losses = 0;

  for (let i = 1; i <= period; i++) {
    const difference = prices[i] - prices[i - 1];
    if (difference >= 0) {
      gains += difference;
    } else {
      losses -= difference;
    }
  }

  let averageGain = gains / period;
  let averageLoss = losses / period;

  const rsiValues = [100 - (100 / (1 + averageGain / averageLoss))];

  for (let i = period + 1; i < prices.length; i++) {
    const difference = prices[i] - prices[i - 1];
    let currentGain = 0;
    let currentLoss = 0;

    if (difference >= 0) {
      currentGain = difference;
    } else {
      currentLoss = -difference;
    }

    averageGain = (averageGain * (period - 1) + currentGain) / period;
    averageLoss = (averageLoss * (period - 1) + currentLoss) / period;

    rsiValues.push(100 - (100 / (1 + averageGain / averageLoss)));
  }

  return rsiValues;
}

function updatePositions(currentPrice) {
  positions = positions.filter(position => {
    if (position.type === 'buy') {
      if (currentPrice <= position.stopLossPrice) {
        logMessage(`Stop loss triggered for buy position. Entry: ${position.entryPrice}, Exit: ${position.stopLossPrice}`);
        return false;
      }
      if (currentPrice >= position.takeProfitPrice) {
        logMessage(`Take profit triggered for buy position. Entry: ${position.entryPrice}, Exit: ${position.takeProfitPrice}`);
        return false;
      }
      const newTrailingStop = currentPrice - position.trailingStopDistance;
      if (newTrailingStop > position.stopLossPrice) {
        position.stopLossPrice = newTrailingStop;
      }
    } else if (position.type === 'sell') {
      if (currentPrice >= position.stopLossPrice) {
        logMessage(`Stop loss triggered for sell position. Entry: ${position.entryPrice}, Exit: ${position.stopLossPrice}`);
        return false;
      }
      if (currentPrice <= position.takeProfitPrice) {
        logMessage(`Take profit triggered for sell position. Entry: ${position.entryPrice}, Exit: ${position.takeProfitPrice}`);
        return false;
      }
      const newTrailingStop = currentPrice + position.trailingStopDistance;
      if (newTrailingStop < position.stopLossPrice) {
        position.stopLossPrice = newTrailingStop;
      }
    }
    return true;
  });
}

function initTradingViewWidget(initialSymbol) {
  if (widget) {
    widget.remove();
  }
  
  widget = new TradingView.widget({
    "width": "100%",
    "height": "100%",
    "symbol": "BINANCE:" + initialSymbol,
    "interval": "15",
    "timezone": "Etc/UTC",
    "theme": "light",
    "style": "1",
    "locale": "br",
    "toolbar_bg": "#f1f3f6",
    "enable_publishing": false,
    "hide_side_toolbar": false,
    "allow_symbol_change": true,
    "studies": [
      "MASimple@tv-basicstudies",
      "MASimple@tv-basicstudies",
      "RSI@tv-basicstudies",
      "MACD@tv-basicstudies",
      "BB@tv-basicstudies"
    ],
    "container_id": "tradingview-widget-container",
    "studies_overrides": {
      "moving average.length": 9,
      "moving average.1.length": 21,
      "relative strength index.length": 14,
      "moving average convergence/divergence.fast length": 12,
      "moving average convergence/divergence.slow length": 26,
      "moving average convergence/divergence.signal smoothing": 9,
      "bollinger bands.length": 20,
      "bollinger bands.stddev": 2
    }
  });
}

function connectWebSocket() {
  if (ws && ws.readyState !== WebSocket.CLOSED) {
    logMessage('WebSocket is already connected or connecting. Closing existing connection.');
    ws.close();
  }
  
  const wsSymbol = symbol.toLowerCase();
  ws = new WebSocket(`wss://fstream.binance.com/ws/${wsSymbol}@kline_${interval}`);

  ws.onopen = () => {
    logMessage(`WebSocket conectado para ${symbol}`);
    reconnectAttempts = 0;
  };

  ws.onmessage = normalWebSocketHandler;

  ws.onerror = (error) => {
    console.error('WebSocket error:', error);
    logMessage(`Erro no WebSocket: ${error.message || 'Erro desconhecido'}`);
  };

  ws.onclose = (event) => {
    console.log('WebSocket closed:', event);
    logMessage(`Conexão WebSocket fechada. Código: ${event.code}, Razão: ${event.reason || 'Não especificada'}`);
    
    if (isRunning && reconnectAttempts < maxReconnectAttempts) {
      const delay = Math.min(30000, baseReconnectDelay * Math.pow(2, reconnectAttempts));
      logMessage(`Tentando reconectar em ${delay / 1000} segundos...`);
      setTimeout(() => {
        reconnectAttempts++;
        connectWebSocket();
      }, delay);
    } else if (reconnectAttempts >= maxReconnectAttempts) {
      logMessage('Número máximo de tentativas de reconexão atingido. Por favor, reinicie o bot manualmente.');
      isRunning = false;
    }
  };
}

async function runBot() {
  if (!isRunning) return;

  try {
    const historicalData = await fetchHistoricalData(symbol, interval, '6 months');
    
    prices = historicalData.prices;
    volumes = historicalData.volumes;

    ema50 = calculateEMA(prices, 50);
    ema200 = calculateEMA(prices, 200);
    rsiValues = calculateRSI(prices);

    reconnectAttempts = 0;
    connectWebSocket();

  } catch (error) {
    console.error('Error in runBot:', error);
    logMessage(`Erro ao executar o bot: ${error.message}`);
    if (error instanceof TypeError) {
      logMessage('Erro de rede. Verifique sua conexão com a internet.');
    }
    isRunning = false;

    setTimeout(() => {
      if (isRunning) {
        logMessage('Tentando reconectar...');
        runBot();
      }
    }, 5000);
  }
}

async function fetchHistoricalData(symbol, interval, duration) {
  const endTime = Date.now();
  const startTime = endTime - (6 * 30 * 24 * 60 * 60 * 1000);

  const response = await fetch(`https://fapi.binance.com/fapi/v1/klines?symbol=${symbol}&interval=${interval}&startTime=${startTime}&endTime=${endTime}`);
  
  if (!response.ok) {
    throw new Error(`HTTP error! status: ${response.status}`);
  }
  
  const data = await response.json();
  return {
    prices: data.map(candle => parseFloat(candle[4])),
    volumes: data.map(candle => parseFloat(candle[5]))
  };
}
</script>
<style>.tradingview-widget-copyright {font-size: 13px !important; line-height: 32px !important; text-align: center !important; vertical-align: middle !important; font-family: -apple-system, BlinkMacSystemFont, 'Trebuchet MS', Roboto, Ubuntu, sans-serif !important; color: #B2B5BE !important;} .tradingview-widget-copyright .blue-text {color: #2962FF !important;} .tradingview-widget-copyright a {text-decoration: none !important; color: #B2B5BE !important;} .tradingview-widget-copyright a:visited {color: #B2B5BE !important;} .tradingview-widget-copyright a:hover .blue-text {color: #1E53E5 !important;} .tradingview-widget-copyright a:active .blue-text {color: #1848CC !important;} .tradingview-widget-copyright a:visited .blue-text {color: #2962FF !important;}</style></body></html>
